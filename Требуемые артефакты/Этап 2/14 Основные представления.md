## 14. Основные архитектурные представления

### 14.1 Функциональное представление

Основные функциональные области:
- управление пользователями и профилями;
- фиксация и анализ тренировок;
- социальные взаимодействия;
- рекомендации и персонализация;
- уведомления и геймификация;
- интеграция с торговыми системами;
- приём и обработка телеметрии.

Каждая функциональная область реализована отдельным доменным сервисом, что обеспечивает:
- слабую связанность;
- независимую эволюцию;
- масштабируемость по функциональным доменам.

### Основные домены и сервисы

#### Домен «Пользователь и профиль»
- **User Service**
  - управление пользовательскими профилями;
  - хранение персональных настроек;
  - управление спортивным инвентарём пользователя;
  - базовая идентификация пользователя внутри платформы.

Этот сервис является фундаментом персонализации и социальной функциональности.

---

#### Домен «Тренировки и прогресс»
- **Training Service**
  - создание и завершение тренировок;
  - хранение результатов тренировок;
  - сравнение с прошлыми результатами;
  - генерация событий о тренировках.

Данный сервис напрямую влияет на пользовательскую ценность приложения.

---

#### Домен «Социальные взаимодействия»
- **Social Service**
  - управление группами и подписками;
  - социальная активность и взаимодействие;
  - ленты активности и достижения.

Социальный домен повышает вовлечённость и удержание пользователей.

---

#### Домен «Рекомендации и персонализация»
- **Recommendation Service**
  - персональные рекомендации по тренировкам;
  - рекомендации спортивного инвентаря;
  - интеграция с аналитикой и ML.

Является ключевым связующим звеном между пользовательскими данными и коммерческими целями.

---

#### Домен «Уведомления и геймификация»
- **Notification Service**
  - push-уведомления;
  - уведомления о достижениях;
  - социальные оповещения.

---

#### Домен «Промо и магазин»
- **Promotion Service**
  - получение промоакций;
  - интеграция с каталогами товаров;
  - запуск маркетинговых кампаний.

Коммерческая логика вынесена во внешние системы.

---

#### Домен «Телеметрия и устройства»
- **Telemetry / Ingestion Service**
  - приём данных с устройств;
  - первичная валидация;
  - передача в потоковую обработку.

---

### Взаимодействие сервисов

- пользовательские запросы — синхронные API;
- аналитика и рекомендации — асинхронные события;
- слабая связанность через Event Bus;
- отсутствие прямых зависимостей между хранилищами.

---

### 14.2 Информационное представление

### Хранилища данных по доменам

| Домен | Сервис | Тип хранилища | Примеры технологий | Обоснование выбора |
|-----|-------|---------------|--------------------|-------------------|
| Пользователи | User Service | Реляционная БД | PostgreSQL / Cloud SQL | Структурированные данные, транзакционность, ACID |
| Тренировки | Training Service | Реляционная БД | PostgreSQL | Сильная согласованность, отчёты, сравнения |
| Социальные данные | Social Service | NoSQL (документная) | MongoDB / DynamoDB | Гибкая схема, быстрые чтения |
| Телеметрия | Telemetry Service | Time-Series DB | InfluxDB / Timestream | Высокий объём, временные ряды |
| События | Event Bus | Log-based storage | Kafka / PubSub | Высокая пропускная способность |
| Аналитика | Analytics Service | Data Warehouse | BigQuery / Redshift | Агрегации, BI, отчёты |
| ML | ML Pipelines | Data Lake | S3 / GCS | Исторические данные, обучение |
| Промо | Promotion Service | Кэш + API | Redis + REST | Быстрый доступ, низкая латентность |

---

### Потоки данных

- **OLTP данные** — обрабатываются внутри доменных сервисов.
- **OLAP данные** — реплицируются через события в аналитические хранилища.
- **Сырые данные** — хранятся отдельно от агрегированных.
- **Коммерческие данные** — не хранятся локально, получаются по API.

#### Поток телеметрии
1. Устройство → Ingestion API
2. Очереди / стриминг
3. Telemetry Store
4. Analytics / ML

#### Поток пользовательских событий
1. Пользовательское действие
2. Доменные сервисы
3. Event Bus
4. Analytics / Notifications / Recommendations

#### Поток коммерческих данных
1. Рекомендации → Магазин
2. События покупок → Event Bus
3. Аналитика и маркетинг

Такой подход снижает связность, упрощает масштабирование и оптимизирует стоимость хранения.

### 14.3 Представление многозадачности (Concurrency)

### Источники параллелизма
- массовые пользовательские действия;
- телеметрия с тысяч устройств;
- аналитические и ML-процессы;
- маркетинговые кампании.

---

### Механизмы по доменам

| Домен | Технологии | Подход |
|-----|-----------|-------|
| Пользователи | REST + Stateless сервисы | Горизонтальное масштабирование |
| Тренировки | REST + Events | Асинхронная аналитика |
| Социальные | Event-driven | Fan-out событий |
| Телеметрия | Kafka / PubSub | Streaming и back-pressure |
| Аналитика | Batch + Stream | Асинхронная обработка |
| Уведомления | Очереди | Отложенная доставка |
| Промо | Кэширование | Минимизация латентности |

---

### Согласованность и блокировки

- отсутствуют глобальные блокировки;
- локальная транзакционность внутри сервисов;
- идемпотентные обработчики;
- eventual consistency между доменами.

---

### Защита от перегрузок

- rate limiting;
- back-pressure;
- circuit breaker;
- bulkhead.

---

### 14.4 Инфраструктурное представление

### 14.4.1 Общая модель развёртывания

Система развёртывается в **multi-region, multi-cloud окружении** с использованием контейнеризации и оркестрации.

Ключевые принципы:
- все сервисы развёртываются в Docker-контейнерах;
- управление осуществляется через Kubernetes;
- сервисы являются stateless (где это возможно);
- состояние вынесено во внешние хранилища.

Такой подход позволяет:
- масштабировать компоненты независимо;
- быстро восстанавливаться после сбоев;
- выполнять частые релизы без простоя.

---

### 14.4.2 Геораспределение и multi-cloud

Система развёртывается как минимум в нескольких географических регионах, потенциально у разных облачных провайдеров.

Используется следующая модель:
- несколько независимых Kubernetes-кластеров;
- глобальный DNS / Traffic Manager;
- маршрутизация пользователей в ближайший регион;
- возможность ручного или автоматического failover.

Преимущества:
- устойчивость к отказу региона или провайдера;
- минимизация латентности для пользователей по всему миру;
- соответствие требованиям локального хранения данных.

---

### 14.4.3 Сетевой уровень и доступ пользователей

#### Внешний доступ
- пользователи подключаются через CDN и edge-узлы;
- CDN выполняет:
  - кеширование статического контента;
  - защиту от DDoS;
  - первичное rate limiting.

#### Внутренние сети
- сервисы изолированы в приватных сетях;
- используются network policies;
- запрещён прямой доступ к БД извне.

---

### 14.4.4 Управление нагрузкой и защита от перегрузок

Защита от перегрузок реализуется **на нескольких уровнях**, что критично для системы с массовыми событиями и телеметрией.

#### Уровень клиента и edge
- CDN ограничивает аномальный трафик;
- базовая фильтрация запросов;
- защита от бот-атак.

---

#### API Gateway
- rate limiting по пользователям и токенам;
- ограничение burst-нагрузки;
- request throttling;
- возврат управляемых ошибок (HTTP 429).

---

#### Сервисный уровень
- circuit breaker между сервисами;
- bulkhead (изоляция пулов);
- тайм-ауты на внешние вызовы;
- graceful degradation (частичное отключение функций).

---

#### Асинхронная обработка
- очереди и стримы принимают нагрузку «на себя»;
- back-pressure при переполнении;
- приоритеты обработки событий;
- отложенная обработка не критичных задач.

---

### 14.4.5 Масштабирование

Масштабирование осуществляется автоматически и прозрачно для пользователей.

Используемые механизмы:
- Horizontal Pod Autoscaler (HPA);
- масштабирование ingestion-слоя по throughput;
- отдельные политики масштабирования для:
  - core-сервисов;
  - телеметрии;
  - аналитики.

Это позволяет системе:
- выдерживать пиковые нагрузки во время соревнований;
- экономить ресурсы в периоды низкой активности.

---

### 14.4.6 CI/CD и управление релизами

Процесс доставки изменений построен по принципу **immutable infrastructure**.

Ключевые элементы:
- единый CI pipeline;
- сборка Docker-образов;
- автоматическое тестирование;
- публикация артефактов в registry;
- деплой без пересборки.

Используемые стратегии выката:
- blue-green deployments;
- canary-релизы;
- feature flags.

Это снижает риски при частых изменениях и экспериментах.

---

### 14.4.7 Эксплуатация и управление

Для управления инфраструктурой используются:
- Infrastructure as Code (Terraform);
- централизованный secrets management;
- автоматическое обновление конфигураций;
- мониторинг состояния кластеров и сервисов.

Операционные задачи максимально автоматизированы, что снижает нагрузку на администраторов и уменьшает человеческий фактор.

---

### 14.4.8 Резервное копирование и восстановление

Для критичных данных предусмотрены:
- регулярные резервные копии баз данных;
- snapshot-копии хранилищ;
- проверенные процедуры восстановления (DRP);
- разные RPO/RTO для разных доменов.

Критичные пользовательские данные восстанавливаются в первую очередь.

---

### 14.5 Представление безопасности

### Аутентификация и авторизация

- централизованная служба аутентификации;
- OAuth2 / OpenID Connect;
- JWT с коротким TTL;
- refresh-токены;
- RBAC для сервисов и пользователей.

---

### Безопасность API

- API Gateway как единая точка контроля;
- rate limiting;
- защита от brute-force;
- проверка схемы запросов;
- versioning API.

---

### Защита данных

- шифрование данных в движении (TLS);
- шифрование данных в хранении;
- токенизация и маскирование PII;
- минимизация хранения чувствительных данных.

---

### Безопасность интеграций

- контрактное взаимодействие с магазином;
- SSO без передачи паролей;
- ограниченные scope’ы доступа;
- аудит интеграционных вызовов.

---

### Инфраструктурная безопасность

- network policies;
- изоляция namespace’ов;
- secrets management;
- контроль прав сервисных аккаунтов.

---

### Observability и аудит

- централизованные логи;
- аудит действий пользователей;
- трассировка запросов;
- security monitoring и алерты.

---

### Соответствие регуляциям

- поддержка GDPR, CCPA;
- управление согласием пользователя;
- право на удаление данных;
- региональная изоляция данных.

---

