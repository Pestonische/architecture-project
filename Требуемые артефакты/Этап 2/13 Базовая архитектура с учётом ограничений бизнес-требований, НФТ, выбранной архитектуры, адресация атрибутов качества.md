## 13. Базовая архитектура системы

Данный раздел описывает базовую архитектуру приложения с учётом бизнес-требований, нефункциональных требований, выбранных архитектурных подходов и адресации ключевых атрибутов качества. Архитектура ориентирована на глобальное масштабирование, высокую вовлечённость пользователей и интеграцию с существующими торговыми системами компании.

---

### 13.1 Архитектурный стиль и принципы

В качестве основного архитектурного подхода выбрана **микросервисная архитектура**, дополненная **событийно-ориентированной моделью взаимодействия**.

Ключевые принципы:
- разделение системы по бизнес-доменам;
- слабая связанность сервисов;
- асинхронное взаимодействие для нефункционально критичных процессов;
- REST / gRPC для пользовательских и управляемых операций;
- event-driven подход для аналитики, телеметрии и рекомендаций.

Данные принципы соответствуют ADR-001 и ADR-002.

---

### 13.2 Основные архитектурные компоненты

#### Клиентский уровень
- Мобильные приложения (iOS / Android)
- Web-клиенты (опционально)

Функции:
- взаимодействие с пользователем;
- сбор данных тренировок;
- отображение рекомендаций и социальной активности;
- переход в торговые приложения компании.

---

#### API Gateway
Единая точка входа для клиентских запросов.

Функции:
- маршрутизация запросов;
- аутентификация и авторизация;
- rate limiting;
- versioning API;
- проксирование запросов в e-commerce системы.

Адресуемые атрибуты качества:
- **Безопасность**
- **Производительность**
- **Наблюдаемость**

---

#### Доменные микросервисы

| Сервис | Назначение |
|------|-----------|
| User Service | профили, предпочтения, инвентарь |
| Training Service | тренировки и прогресс |
| Social Service | группы, подписки, взаимодействие |
| Recommendation Service | персонализация и подсказки |
| Notification Service | push и социальные уведомления |
| Promotion Service | промоакции и интеграция с магазином |

Каждый сервис:
- владеет собственной базой данных;
- масштабируется независимо;
- разрабатывается автономной командой.

---

#### Telemetry & Ingestion Layer
Компоненты приёма и обработки телеметрии:
- ingestion API;
- очереди сообщений;
- потоковая обработка данных.

Используется для:
- данных с устройств;
- фитнес-датчиков;
- мобильных сенсоров.

Адресуемые атрибуты качества:
- **Производительность**
- **Масштабируемость**

---

#### Event Bus
Асинхронный обмен событиями между сервисами:
- события тренировок;
- социальные события;
- маркетинговые события;
- события магазина.

Используется для:
- аналитики;
- ML-процессов;
- уведомлений;
- интеграции с магазином.

---

#### Аналитика и ML
Компоненты:
- аналитические сервисы;
- хранилища событий;
- ML pipelines.

Назначение:
- построение моделей рекомендаций;
- сегментация пользователей;
- поддержка маркетинговых гипотез.

---

#### Интеграция с магазином
Реализуется через:
- REST API каталога и промоакций;
- SSO для бесшовного перехода;
- события покупок и просмотров.

Важно:  
Коммерческая логика **не дублируется**, что соответствует ADR-004.

---

### 13.3 Адресация атрибутов качества (Quality Attributes)

#### Производительность
- асинхронная обработка событий;
- кэширование горячих данных;
- edge routing для клиентов.

---

#### Масштабируемость
- горизонтальное масштабирование сервисов;
- масштабируемый ingestion слой;
- event streaming вместо point-to-point.

---

#### Надёжность и доступность
- отказ одного сервиса не блокирует систему;
- retry, circuit breaker, bulkhead;
- multi-region размещение.

---

#### Безопасность и приватность
- минимизация PII;
- шифрование данных;
- разделение доступов;
- соответствие региональным регуляциям.

---

#### Наблюдаемость
- централизованные логи;
- распределённая трассировка;
- бизнес-метрики и SLA.

---

#### Развиваемость
- чёткие API-контракты;
- независимые релизы;
- feature flags;
- постепенное внедрение новых функций.

---

### 13.4 Связь архитектуры с бизнес-требованиями

| Бизнес-требование | Архитектурное решение |
|------------------|----------------------|
| Глобальная аудитория | multi-region, multi-cloud |
| Социальные функции | отдельный Social Service |
| Телеметрия | ingestion + events |
| Продажи | интеграция с магазином |
| Эксперименты | event-driven + ML |

---

### 13.5 Ограничения и допущения

- система развивается итеративно;
- часть функциональности вводится поэтапно;
- внешние системы магазина имеют собственные SLA;
- observability является обязательной частью архитектуры.

---

### 13.6 Архитектурная диаграмма системы

<img width="1746" height="1026" alt="image" src="https://github.com/user-attachments/assets/9ffd9f78-6121-4a43-8968-dedbe0a827af" />

Данная архитектурная диаграмма отражает логическую структуру системы и основные интеграционные потоки между её компонентами.

В центре архитектуры находится Core Domain, включающий сервисы тренировок, социальных взаимодействий и геймификации, которые формируют основную ценность продукта для пользователей. Эти сервисы обрабатывают ключевые пользовательские сценарии и являются критичными для бизнеса.

Сервисы идентификации пользователей, рекомендаций, промоакций и интеграции с e-commerce относятся к поддерживающим доменам и обеспечивают работу Core Domain, не нарушая его изоляции.

Аутентификация и авторизация реализованы через выделенный Auth Service, отвечающий за управление идентификацией и SSO. API Gateway выполняет исключительно технические функции — маршрутизацию запросов, валидацию токенов и контроль доступа, не включая в себя бизнес-логику.

Для асинхронного взаимодействия между сервисами и обработки событий используется Event Bus, что позволяет масштабировать систему и снижать связанность компонентов. Телеметрия и данные тренировок поступают через ingestion-слой и обрабатываются в аналитическом контуре, отделённом от транзакционных сервисов.

Такое разделение ответственности позволяет системе масштабироваться, обеспечивать высокую надёжность и упрощает дальнейшее развитие платформы.

---

### 13.7 Диаграмма компонентов

<img width="1631" height="1120" alt="image" src="https://github.com/user-attachments/assets/9b2d5a5e-f30d-4c16-af72-eb9921b0d391" />

---

### 13.8 Диаграмма развёртывания

<img width="1757" height="894" alt="image" src="https://github.com/user-attachments/assets/22c99a40-e7b0-46e6-942e-77db25943c2d" />
